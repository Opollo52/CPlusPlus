#pragma once
#include <vector>
#include <iostream>
#include <algorithm>
#include "colors.h"

struct Tile {
    int id;
    std::vector<std::vector<int>> shape;
};

class GameTile {
private:
    std::vector<Position> shape;
    
    void normalize() {
        if (shape.empty()) return;
        
        int minX = shape[0].x, minY = shape[0].y;
        for (const auto& pos : shape) {
            minX = std::min(minX, pos.x);
            minY = std::min(minY, pos.y);
        }
        
        for (auto& pos : shape) {
            pos.x -= minX;
            pos.y -= minY;
        }
        
        for (size_t i = 0; i < shape.size(); i++) {
            if (shape[i].x == 0 && shape[i].y == 0) {
                if (i != 0) {
                    std::swap(shape[0], shape[i]);
                }
                break;
            }
        }
    }
    
public:
    GameTile() {}
    GameTile(const ::Tile& tileData) {
        for (int y = 0; y < tileData.shape.size(); y++) {
            for (int x = 0; x < tileData.shape[y].size(); x++) {
                if (tileData.shape[y][x] == 1) {
                    shape.push_back(Position(x, y));
                }
            }
        }
        normalize();
    }
    GameTile(std::vector<Position> s) : shape(s) { 
        normalize();
    }
    
    std::vector<Position> getShape() const { return shape; }
    int getSize() const { return shape.size(); }
    
    void displayPreview() const {
        if (shape.empty()) return;
        
        int minX = shape[0].x, maxX = shape[0].x;
        int minY = shape[0].y, maxY = shape[0].y;
        
        for (const auto& pos : shape) {
            minX = std::min(minX, pos.x);
            maxX = std::max(maxX, pos.x);
            minY = std::min(minY, pos.y);
            maxY = std::max(maxY, pos.y);
        }
        
        for (int y = minY; y <= maxY; y++) {
            for (int x = minX; x <= maxX; x++) {
                bool found = false;
                bool isReference = false;
                for (const auto& pos : shape) {
                    if (pos.x == x && pos.y == y) {
                        found = true;
                        if (pos.x == minX && pos.y == minY) {
                            isReference = true;
                        }
                        break;
                    }
                }
                if (found) {
                    if (isReference) {
                        std::cout << colorText("#", RED);
                    } else {
                        std::cout << "#";
                    }
                } else {
                    std::cout << ".";
                }
            }
            std::cout << "\n";
        }
    }
    
    void rotate90() {
        for (auto& pos : shape) {
            int temp = pos.x;
            pos.x = -pos.y;
            pos.y = temp;
        }
        normalize();
    }
    
    void flip() {
        for (auto& pos : shape) {
            pos.x = -pos.x;
        }
        normalize();
    }
    
    std::vector<Position> getAbsolutePositions(Position base) const {
        std::vector<Position> result;
        for (const auto& pos : shape) {
            result.push_back(Position(base.x + pos.x, base.y + pos.y));
        }
        return result;
    }
};

static const std::vector<Tile> ALL_TILES = {
    { 0, {
        {1, 1},
        {1, 0}
    } },
    { 1, {
        {1, 1},
        {0, 1}
    } },
    { 2, {
        {1, 1, 0},
        {0, 1, 1}
    } },
    { 3, {
        {0, 1, 1},
        {1, 1, 0}
    } },
    { 4, {
        {1, 1, 1},
        {1, 0, 0}
    } },
    { 5, {
        {1, 1, 1},
        {0, 0, 1}
    } },
    { 6, {
        {1, 1, 1},
        {0, 1, 0}
    } },
    { 7, {
        {1, 1},
        {1, 0},
        {1, 0}
    } },
    { 8, {
        {1, 1},
        {0, 1},
        {0, 1}
    } },
    { 9, {
        {1, 1},
        {1, 1}
    } },
    { 10, {
        {1, 1, 1},
        {1, 0, 1}
    } },
    { 11, {
        {1, 1, 1},
        {0, 1, 1}
    } },
    { 12, {
        {1, 1, 1},
        {1, 1, 0}
    } },
    { 13, {
        {1, 1, 1},
        {0, 1, 0},
        {0, 1, 0}
    } },
    { 14, {
        {1, 1, 1},
        {1, 0, 0},
        {1, 0, 0}
    } },
    { 15, {
        {1, 1, 1},
        {0, 0, 1},
        {0, 0, 1}
    } },
    { 16, {
        {1, 1, 0},
        {0, 1, 1},
        {0, 0, 1}
    } },
    { 17, {
        {0, 1, 1},
        {1, 1, 0},
        {1, 0, 0}
    } },
    { 18, {
        {1, 1, 0},
        {1, 1, 1}
    } },
    { 19, {
        {0, 1, 1},
        {1, 1, 1}
    } },
    { 20, {
        {1, 1, 1, 1}
    } },
    { 21, {
        {1},
        {1},
        {1},
        {1}
    } },
    { 22, {
        {1, 1, 1},
        {0, 1, 0},
        {1, 1, 0}
    } },
    { 23, {
        {1, 1, 1},
        {0, 1, 0},
        {0, 1, 1}
    } },
    { 24, {
        {1, 1, 1, 0},
        {0, 0, 1, 1}
    } },
    { 25, {
        {0, 1, 1, 1},
        {1, 1, 0, 0}
    } },
    { 26, {
        {1, 1, 0},
        {1, 0, 0},
        {1, 1, 1}
    } },
    { 27, {
        {0, 1, 1},
        {0, 0, 1},
        {1, 1, 1}
    } },
    { 28, {
        {1, 1, 1},
        {1, 0, 1},
        {0, 0, 1}
    } },
    { 29, {
        {1, 1, 1},
        {1, 0, 1},
        {1, 0, 0}
    } },
    { 30, {
        {1, 1, 1},
        {0, 1, 1},
        {0, 0, 1}
    } },
    { 31, {
        {1, 1, 1},
        {1, 1, 0},
        {1, 0, 0}
    } },
    { 32, {
        {1, 1, 0},
        {1, 0, 0},
        {1, 1, 0}
    } },
    { 33, {
        {0, 1, 1},
        {0, 0, 1},
        {0, 1, 1}
    } },
    { 34, {
        {1, 1, 1},
        {1, 0, 0},
        {1, 1, 1}
    } },
    { 35, {
        {1, 1, 1},
        {0, 0, 1},
        {1, 1, 1}
    } },
    { 36, {
        {1, 1, 1},
        {0, 1, 0},
        {1, 1, 1}
    } },
    { 37, {
        {1, 1, 1, 1},
        {0, 1, 0, 0}
    } },
    { 38, {
        {1, 1, 1, 1},
        {0, 0, 1, 0}
    } },
    { 39, {
        {1, 1, 1, 1},
        {1, 0, 0, 0}
    } },
    { 40, {
        {1, 1, 1, 1},
        {0, 0, 0, 1}
    } },
    { 41, {
        {1, 1, 1, 0},
        {0, 1, 1, 1}
    } },
    { 42, {
        {0, 1, 1, 1},
        {1, 1, 1, 0}
    } },
    { 43, {
        {1, 1, 1, 0},
        {1, 0, 1, 1}
    } },
    { 44, {
        {0, 1, 1, 1},
        {1, 1, 0, 1}
    } },
    { 45, {
        {1, 1, 1, 0},
        {0, 0, 1, 1}
    } },
    { 46, {
        {0, 1, 1, 1},
        {1, 1, 0, 0}
    } },
    { 47, {
        {1, 1, 0, 0},
        {0, 1, 1, 1}
    } },
    { 48, {
        {0, 0, 1, 1},
        {1, 1, 1, 0}
    } },
    { 49, {
        {1, 1, 1, 1},
        {0, 1, 1, 0}
    } },
    { 50, {
        {1, 1, 1, 1},
        {1, 0, 0, 1}
    } },
    { 51, {
        {1, 1, 1, 1},
        {1, 0, 1, 0}
    } },
    { 52, {
        {1, 1, 1, 1},
        {0, 1, 0, 1}
    } },
    { 53, {
        {1, 1, 1, 0},
        {1, 0, 1, 1}
    } },
    { 54, {
        {0, 1, 1, 1},
        {1, 1, 0, 1}
    } },
    { 55, {
        {1, 1, 0, 1},
        {0, 1, 1, 1}
    } },
    { 56, {
        {1, 0, 1, 1},
        {1, 1, 1, 0}
    } },
    { 57, {
        {1, 1, 1, 0},
        {0, 1, 0, 0},
        {0, 1, 1, 0}
    } },
    { 58, {
        {0, 1, 1, 1},
        {0, 0, 1, 0},
        {0, 1, 1, 0}
    } },
    { 59, {
        {1, 1, 1, 0},
        {1, 0, 0, 0},
        {1, 1, 0, 0}
    } },
    { 60, {
        {0, 1, 1, 1},
        {0, 0, 0, 1},
        {0, 0, 1, 1}
    } },
    { 61, {
        {1, 1, 0, 0},
        {1, 0, 0, 0},
        {1, 1, 1, 0}
    } },
    { 62, {
        {0, 0, 1, 1},
        {0, 0, 0, 1},
        {0, 1, 1, 1}
    } },
    { 63, {
        {1, 1, 1, 0},
        {0, 1, 0, 0},
        {1, 1, 0, 0}
    } },
    { 64, {
        {0, 1, 1, 1},
        {0, 1, 0, 0},
        {0, 1, 1, 1}
    } },
    { 65, {
        {1, 1, 0, 0},
        {0, 1, 0, 0},
        {1, 1, 1, 0}
    } },
    { 66, {
        {0, 0, 1, 1},
        {0, 0, 1, 0},
        {0, 1, 1, 1}
    } },
    { 67, {
        {1, 1, 1, 0},
        {0, 1, 1, 0},
        {0, 0, 1, 0}
    } },
    { 68, {
        {0, 1, 1, 1},
        {0, 1, 1, 0},
        {0, 1, 0, 0}
    } },
    { 69, {
        {1, 1, 1, 0},
        {1, 1, 0, 0},
        {0, 1, 0, 0}
    } },
    { 70, {
        {0, 1, 1, 1},
        {0, 0, 1, 1},
        {0, 0, 1, 0}
    } },
    { 71, {
        {1, 1, 0, 0},
        {1, 1, 1, 0},
        {0, 1, 0, 0}
    } },
    { 72, {
        {0, 0, 1, 1},
        {0, 1, 1, 1},
        {0, 0, 1, 0}
    } },
    { 73, {
        {1, 1, 1, 0},
        {0, 1, 0, 0},
        {0, 1, 1, 0}
    } },
    { 74, {
        {0, 1, 1, 1},
        {0, 1, 0, 0},
        {0, 1, 1, 0}
    } },
    { 75, {
        {1, 1, 1, 0},
        {1, 0, 1, 0},
        {1, 1, 0, 0}
    } },
    { 76, {
        {0, 1, 1, 1},
        {0, 1, 0, 1},
        {0, 1, 0, 0}
    } },
    { 77, {
        {1, 1, 0, 0},
        {0, 1, 1, 0},
        {0, 1, 1, 0}
    } },
    { 78, {
        {0, 0, 1, 1},
        {0, 1, 1, 0},
        {0, 1, 1, 0}
    } },
    { 79, {
        {1, 1, 1, 0},
        {1, 0, 1, 0},
        {1, 0, 0, 0}
    } },
    { 80, {
        {0, 1, 1, 1},
        {0, 1, 0, 1},
        {0, 0, 0, 1}
    } },
    { 81, {
        {1, 1, 1, 0},
        {0, 1, 1, 0},
        {1, 0, 0, 0}
    } },
    { 82, {
        {0, 1, 1, 1},
        {0, 1, 1, 0},
        {0, 0, 1, 1}
    } },
    { 83, {
        {1, 1, 0, 0},
        {1, 1, 1, 0},
        {1, 0, 0, 0}
    } },
    { 84, {
        {0, 0, 1, 1},
        {0, 1, 1, 1},
        {0, 0, 0, 1}
    } },
    { 85, {
        {1, 1, 1, 0},
        {0, 1, 1, 0},
        {0, 0, 1, 0}
    } },
    { 86, {
        {0, 1, 1, 1},
        {0, 1, 1, 0},
        {0, 1, 0, 0}
    } },
    { 87, {
        {1, 1, 1, 0},
        {1, 1, 0, 0},
        {0, 1, 0, 0}
    } },
    { 88, {
        {0, 1, 1, 1},
        {0, 0, 1, 1},
        {0, 0, 1, 0}
    } },
    { 89, {
        {1, 1, 0, 0},
        {1, 1, 1, 0},
        {0, 1, 0, 0}
    } },
    { 90, {
        {0, 0, 1, 1},
        {0, 1, 1, 1},
        {0, 0, 1, 0}
    } },
    { 91, {
        {1, 1, 1, 0},
        {0, 1, 0, 0},
        {1, 1, 0, 0}
    } },
    { 92, {
        {0, 1, 1, 1},
        {0, 1, 0, 0},
        {0, 1, 1, 1}
    } },
    { 93, {
        {1, 1, 0, 0},
        {0, 1, 0, 0},
        {1, 1, 1, 0}
    } },
    { 94, {
        {0, 0, 1, 1},
        {0, 0, 1, 0},
        {0, 1, 1, 1}
    } },
    { 95, {
        {1, 1, 1, 0},
        {0, 1, 1, 0},
        {0, 0, 1, 0}
    } }
};
